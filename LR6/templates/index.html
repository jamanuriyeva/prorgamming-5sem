<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .client-info {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .currency-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .currency-card:hover {
            transform: translateY(-5px);
        }

        .currency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .currency-code {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .currency-rate {
            font-size: 28px;
            font-weight: bold;
            color: #27ae60;
            text-align: center;
            margin: 10px 0;
        }

        .change-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .change-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .change-neutral {
            color: #7f8c8d;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .last-update {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 20px;
        }

        .change-info {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .change-item {
            text-align: center;
        }

        .change-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .change-value {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –¶–ë –†–§</h1>
        <p>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å" —Å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏</p>
    </div>

    <div class="client-info">
        ID –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è: <span id="observerId">-</span>
    </div>

    <div id="status" class="status disconnected">
        üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    </div>

    <div class="currency-grid" id="currencyGrid">
        <!-- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <div class="last-update" id="lastUpdate">
        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ω–∏–∫–æ–≥–¥–∞
    </div>

    <script>
        class CurrencyMonitor {
            constructor() {
                this.ws = null;
                this.observerId = null;
                this.isConnected = false;
                this.currencyTemplates = {};

                this.initializeWebSocket();
                this.setupTemplates();
            }

            setupTemplates() {
                // –®–∞–±–ª–æ–Ω—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–∞–ª—é—Ç
                const currencies = ['USD', 'EUR', 'GBP', 'CNY', 'JPY'];
                currencies.forEach(currency => {
                    this.currencyTemplates[currency] = this.createCurrencyCard(currency);
                });
            }

            createCurrencyCard(currencyCode) {
                const card = document.createElement('div');
                card.className = 'currency-card';
                card.id = `currency-${currencyCode}`;
                card.innerHTML = `
                    <div class="currency-header">
                        <div class="currency-code">${currencyCode}</div>
                        <div class="currency-name">${this.getCurrencyName(currencyCode)}</div>
                    </div>
                    <div class="currency-rate" id="rate-${currencyCode}">-</div>
                    <div class="change-info">
                        <div class="change-item">
                            <div class="change-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</div>
                            <div class="change-value" id="change-abs-${currencyCode}">-</div>
                        </div>
                        <div class="change-item">
                            <div class="change-label">%</div>
                            <div class="change-value" id="change-pct-${currencyCode}">-</div>
                        </div>
                    </div>
                `;
                return card;
            }

            getCurrencyName(code) {
                const names = {
                    'USD': '–î–æ–ª–ª–∞—Ä –°–®–ê',
                    'EUR': '–ï–≤—Ä–æ',
                    'GBP': '–ë—Ä–∏—Ç–∞–Ω—Å–∫–∏–π —Ñ—É–Ω—Ç',
                    'CNY': '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å',
                    'JPY': '–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞'
                };
                return names[code] || code;
            }

            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/websocket`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    this.isConnected = true;
                    this.updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'connected');
                };

                this.ws.onclose = () => {
                    console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                    this.isConnected = false;
                    this.updateStatus('üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'disconnected');

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        this.initializeWebSocket();
                    }, 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                    this.updateStatus('üî¥ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'disconnected');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'welcome':
                        this.observerId = message.observer_id;
                        document.getElementById('observerId').textContent = this.observerId;
                        console.log(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å #${this.observerId}`);
                        break;

                    case 'currency_update':
                        this.updateCurrencyRates(message.data);
                        break;

                    case 'pong':
                        // –û—Ç–≤–µ—Ç –Ω–∞ ping
                        break;
                }
            }

            updateCurrencyRates(data) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const updateTime = new Date(data.timestamp).toLocaleString('ru-RU');
                document.getElementById('lastUpdate').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${updateTime}`;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
                const currencyGrid = document.getElementById('currencyGrid');
                currencyGrid.innerHTML = '';

                Object.entries(data.rates).forEach(([currency, rate]) => {
                    const card = this.currencyTemplates[currency];
                    if (card) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å
                        const rateElement = card.querySelector('.currency-rate');
                        rateElement.textContent = `${rate.toFixed(4)} —Ä—É–±.`;

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        const change = data.changes[currency];
                        if (change) {
                            const absChangeElement = card.querySelector(`#change-abs-${currency}`);
                            const pctChangeElement = card.querySelector(`#change-pct-${currency}`);

                            const absClass = change.absolute > 0 ? 'change-positive' :
                                           change.absolute < 0 ? 'change-negative' : 'change-neutral';
                            const pctClass = change.percent > 0 ? 'change-positive' :
                                           change.percent < 0 ? 'change-negative' : 'change-neutral';

                            absChangeElement.textContent = change.absolute > 0 ? `+${change.absolute.toFixed(4)}` : change.absolute.toFixed(4);
                            absChangeElement.className = `change-value ${absClass}`;

                            pctChangeElement.textContent = change.percent > 0 ? `+${change.percent.toFixed(2)}%` : `${change.percent.toFixed(2)}%`;
                            pctChangeElement.className = `change-value ${pctClass}`;
                        }

                        currencyGrid.appendChild(card.cloneNode(true));
                    }
                });
            }

            updateStatus(message, className) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${className}`;
            }

            sendPing() {
                if (this.isConnected && this.ws) {
                    this.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.currencyMonitor = new CurrencyMonitor();

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ ping –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            setInterval(() => {
                window.currencyMonitor.sendPing();
            }, 30000);
        });
    </script>
</body>
</html>